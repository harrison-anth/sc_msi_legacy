---
title: "SC-ANOVA"
author: "Harrison Anthony"
date: "2024-12-16"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message=FALSE,dev='png',dpi=300)
```
```{r libs-and-functions}

#load libs
library(Seurat)
library(RColorBrewer)
library(gridExtra)
library(patchwork)
library(tidyverse)
library(scAnnotatR)
library(data.table)
library(cowplot)
library(Nebulosa)
library(ggpubr)
library(R.utils)
library(kableExtra)

#set seed
set.seed(seed = 152727)


```

```{r handle-data}
#prep key
key <- fread('C:/Users/Harrison Anthony/Desktop/git_repos/sc_msi/manifests/combined_key.tsv')
key <- filter(key, msi_status=='MSI-H')
patients <- unique(key$patient_id)
patients <- 'P18'
treatment_meta_data <- fread('C:/Users/Harrison Anthony/Desktop/git_repos/sc_msi/manifests/final_gsm_key2.tsv')
key$treatment <- NA
for(i in 1:nrow(key)){
  if(key$patient_id[i] %in% treatment_meta_data$patient_id){
    treatment <- filter(treatment_meta_data, patient_id == key$patient_id[i]) %>% select('treatment')
    key$treatment[i]<- treatment
  }
}

#start with just one patient

patient <- 'P32' 


assign(x = 's_obj',value = readRDS(paste0('E:/temp/newest_dir/',patient,'.rds'))) 
assign(x = 's_obj_cancer',value = readRDS(paste0('E:/temp/newest_dir/',patient,'_cancer.rds')))

  
  



#create centroid info for num of cells labelling
cluster_counts <- table(Idents(s_obj))
s_obj$cluster_counts <- s_obj$integrated.clusters
temp <- as.numeric(levels(s_obj$cluster_counts))[s_obj$cluster_counts]
z=0
for(i in 1:length(cluster_counts)){
temp[temp == z]  <- paste0('n= ',as.numeric(cluster_counts[i]))
 z=z+1 
}
s_obj$cluster_counts <- temp

#quickly add pseuduobulk data
pseudobulk_status <- fread(paste0('C:/Users/Harrison Anthony/Desktop/git_repos/sc_msi/sensor_rna_results/',patient,'.txt'))
pseudobulk_status$sample_id <- gsub(pattern = 'g',replacement = '',x = pseudobulk_status$sample_id)
s_obj$pseudobulk_msi <- NA
cluster_key <- data.frame(cells=colnames(s_obj),cluster=s_obj$seurat_clusters)

for(i in 1:length(s_obj$pseudobulk_msi)){
  cell <- cluster_key$cells[i]
  cluster <- cluster_key$cluster[i]
  temp <- filter(pseudobulk_status, sample_id == as.numeric(as.character(cluster)))
  if(nrow(temp)==0){next}
  s_obj$pseudobulk_msi[i] <- temp$`probability_of_MSI-H`
  
  
}
#quickly add pseuduobulk data cancer
pseudobulk_status_cancer <- fread(paste0('C:/Users/Harrison Anthony/Desktop/git_repos/sc_msi/sensor_rna_results/',patient,'_cancer.txt'))
pseudobulk_status_cancer$sample_id <- gsub(pattern = 'g',replacement = '',x = pseudobulk_status_cancer$sample_id)
s_obj_cancer$pseudobulk_msi <- NA
cluster_key_cancer <- data.frame(cells=colnames(s_obj_cancer),cluster=s_obj_cancer$seurat_clusters)

for(i in 1:length(s_obj_cancer$pseudobulk_msi)){
  cell <- cluster_key_cancer$cells[i]
  cluster <- cluster_key_cancer$cluster[i]
  temp <- filter(pseudobulk_status_cancer, sample_id == as.numeric(as.character(cluster)))
 if(nrow(temp)==0){next}
  s_obj_cancer$pseudobulk_msi[i] <- temp$`probability_of_MSI-H`
  
  
}

plot_me <- data.frame(patient_id=patient,
                      cluster=s_obj_cancer$seurat_clusters,
                      msi_score=s_obj_cancer$sensor_rna_prob,
                      status=s_obj_cancer$sensor_rna_status)





```
```{r plotter}
boxplot(msi_score~cluster,data = plot_me)




```
